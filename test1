
// On place les composantes dans un dossier $WORKSPACE/base_folder
def base_folder = "moodle"

// On obtient l'emplacement a partir du nom de depot
// S'il y a une composante que ne possede pas le bon nom on l'explicite
// dans components
def findInstallPath(String name, String base_folder) {
	def parts = name.split(/\//)[1]
	def components = parts.split(/_/)
	// On place les composantes dans un dossier $WORKSPACE/base_folder
    def component_path = "${base_folder}/" + components.join("/")

}


// On veu pouvoir placer des elements ailleurs
def components = [
    'uqam/moodle': "${base_folder}",
    'uqam/auth_saml2': null,
	'uqam/moodle_infra': '${WORKSPACE}' 
]

// Si une composante utilise une autre branche que UQAM_30_DEV, on l'explicite ici
def mybranches = [
	'uqam/moodle': 'MOODLE_33_STABLE', 
	'uqam/moodle_infra': 'UQAM_WEB'
]

job('Moodle-test') {
	multiscm {
	 def mycomps = components.keySet()
		mycomps.each {
		    def depot = "https://bitbucket.org/"+"${it}"+".git"
		    // On peut overrrider le chemin 
		    def folder = components["${it}"]?  components["${it}"]: findInstallPath("${it}", "${base_folder}")
		    def mybranch = mybranches["${it}"]
			git {
	            remote {
	                url(depot)
	                // C'est le id de l'identifiant..
	                credentials('b49e52ff-27c6-4d38-b288-dbcd2daef492')
	                if (mybranch == null) {
	                	branch('UQAM_30_DEV')
	                } else {
	                	branch(mybranch)
	                }
	            }
	            extensions {
		            cleanAfterCheckout()
		            relativeTargetDirectory(folder)
	            }
	    	}
		
		}
	}

	steps {
	    // Etape anterieure genere folders @tmp qu'on veut efface.
		shell("find \$WORKSPACE -name '*@tmp' -exec rm -rf {} +; ")

		dockerBuildAndPublish {
            repositoryName('nmolleruq/uqammdl')
            tag('${GIT_REVISION,length=5}')
            registryCredentials('dockerhub')
            forcePull(false)
            forceTag(false)
            createFingerprints(false)
            skipDecorate()
        }
	}
}