
def findInstallPath(String name) {
	def parts = name.split(/\//)[1]
	def components = parts.split(/_/)
	// On place les composantes dans un dossier $WORKSPACE/moodle
    components.add(0, "moodle")
	components.join("/")

}


// On veu pouvoir placer des elements ailleurs
def components = [
    'uqam/moodle': ,
    'uqam/auth_saml2': ,
	'uqam/moodle_infra': '${WORKSPACE}' 
]

def mybranches = [
	'uqam/moodle': 'MOODLE_33_STABLE', 
	'uqam/moodle_infra': 'UQAM_WEB'
]

job('Moodle-test') {
	multiscm {
	 def mycomps = components.keySet()
		mycomps.each {
		    def depot = "https://bitbucket.org/"+"${it}"+".git"
		    // def folder = components["${it}"]
		    // On peut overrrider le chemin 
		    def folder = components["${it}"]?  components["${it}"]: findInstallPath("${it}")
		    def mybranch = mybranches["${it}"]
			git {
	            remote {
	                url(depot)
	                // C'est le id de l'identifiant..
	                credentials('b49e52ff-27c6-4d38-b288-dbcd2daef492')
	                if (mybranch == null) {
	                	branch('UQAM_30_DEV')
	                } else {
	                	branch(mybranch)
	                }
	            }
	            extensions {
		            cleanAfterCheckout()
		            relativeTargetDirectory(folder)
	            }
	    	}
		
		}
	}

	steps {
	    // Etape anterieure genere folder @tmp qu'on veut efface.
		shell("find \$WORKSPACE -name '*@tmp' -exec rm -rf {} +; ")

		dockerBuildAndPublish {
            repositoryName('nmolleruq/uqammdl')
            tag('${GIT_REVISION,length=5}')
            registryCredentials('dockerhub')
            forcePull(false)
            forceTag(false)
            createFingerprints(false)
            skipDecorate()
        }
	}
}